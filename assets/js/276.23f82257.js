(window.webpackJsonp=window.webpackJsonp||[]).push([[276],{608:function(s,a,n){"use strict";n.r(a);var t=n(4),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"es详解-入门-查询和聚合的基础使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#es详解-入门-查询和聚合的基础使用"}},[s._v("#")]),s._v(" ES详解 - 入门：查询和聚合的基础使用")]),s._v(" "),a("blockquote",[a("p",[s._v("安装完ElasticSearch 和 Kibana后，为了快速上手，我们通过官网GitHub提供的一个数据进行入门学习，主要包括"),a("strong",[s._v("查询数据")]),s._v("\n和"),a("strong",[s._v("聚合数据")]),s._v(" 。")])]),s._v(" "),a("h2",{attrs:{id:"入门-从索引文档开始"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#入门-从索引文档开始"}},[s._v("#")]),s._v(" 入门：从索引文档开始")]),s._v(" "),a("ul",[a("li",[s._v("索引一个文档")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('PUT /customer/_doc/1\n{\n  "name": "John Doe"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("为了方便测试，我们使用kibana的dev tool来进行学习测试：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-1.png",alt:"img"}})]),s._v(" "),a("p",[s._v("查询刚才插入的文档")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-2.png",alt:"img"}})]),s._v(" "),a("h2",{attrs:{id:"学习准备-批量索引文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#学习准备-批量索引文档"}},[s._v("#")]),s._v(" 学习准备：批量索引文档")]),s._v(" "),a("blockquote",[a("p",[s._v("ES 还提供了批量操作，比如这里我们可以使用批量操作来插入一些数据，供我们在后面学习使用。")])]),s._v(" "),a("p",[s._v("使用批量来批处理文档操作比单独提交请求要快得多，因为它减少了网络往返。")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("下载测试数据")])])]),s._v(" "),a("p",[s._v("数据是index为bank，accounts.json\n"),a("a",{attrs:{href:"https://github.com/elastic/elasticsearch/blob/v6.8.18/docs/src/test/resources/accounts.json",target:"_blank",rel:"noopener noreferrer"}},[s._v("下载地址在新窗口打开"),a("OutboundLink")],1),s._v("（如果你无法下载，也可以clone\nES的"),a("a",{attrs:{href:"https://github.com/elastic/elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方仓库在新窗口打开"),a("OutboundLink")],1),s._v("，选择本文中使用的版本分支，然后进入/docs/src/test/resources/accounts.json目录获取）")]),s._v(" "),a("p",[s._v("数据的格式如下")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"account_number"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"balance"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16623")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"firstname"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Bradshaw"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lastname"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Mckenzie"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"age"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"gender"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"F"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"address"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"244 Columbus Place"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"employer"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Euron"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"email"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bradshawmckenzie@euron.com"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"city"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hobucken"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"state"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"CO"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("ul",[a("li",[a("strong",[s._v("批量插入数据")])])]),s._v(" "),a("p",[s._v("将accounts.json拷贝至指定目录，我这里放在"),a("code",[s._v("/opt/")]),s._v("下面,")]),s._v(" "),a("p",[s._v("然后执行")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/json"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-XPOST")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"localhost:9200/bank/_bulk?pretty&refresh"')]),s._v(" --data-binary "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@/opt/accounts.json"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("strong",[s._v("查看状态")])])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("elasticsearch-centos root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"localhost:9200/_cat/indices?v=true"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" bank\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1524")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1524")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   119k      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" --:--:-- --:--:-- --:--:--  124k\nyellow "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v("   bank                            yq3eSlAWRMO2Td0Sl769rQ   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("379")]),s._v(".2kb        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("379")]),s._v(".2kb\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("elasticsearch-centos root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"查询数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询数据"}},[s._v("#")]),s._v(" 查询数据")]),s._v(" "),a("blockquote",[a("p",[s._v("我们通过kibana来进行查询测试。")])]),s._v(" "),a("h3",{attrs:{id:"查询所有"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询所有"}},[s._v("#")]),s._v(" 查询所有")]),s._v(" "),a("p",[a("code",[s._v("match_all")]),s._v("表示查询所有的数据，"),a("code",[s._v("sort")]),s._v("即按照什么字段排序")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": { "match_all": {} },\n  "sort": [\n    { "account_number": "asc" }\n  ]\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-3.png",alt:"img"}})]),s._v(" "),a("p",[s._v("相关字段解释")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("took")]),s._v(" – Elasticsearch运行查询所花费的时间（以毫秒为单位）")]),s._v(" "),a("li",[a("code",[s._v("timed_out")]),s._v(" –搜索请求是否超时")]),s._v(" "),a("li",[a("code",[s._v("_shards")]),s._v(" - 搜索了多少个碎片，以及成功，失败或跳过了多少个碎片的细目分类。")]),s._v(" "),a("li",[a("code",[s._v("max_score")]),s._v(" – 找到的最相关文档的分数")]),s._v(" "),a("li",[a("code",[s._v("hits.total.value")]),s._v(" - 找到了多少个匹配的文档")]),s._v(" "),a("li",[a("code",[s._v("hits.sort")]),s._v(" - 文档的排序位置（不按相关性得分排序时）")]),s._v(" "),a("li",[a("code",[s._v("hits._score")]),s._v(" - 文档的相关性得分（使用match_all时不适用）")])]),s._v(" "),a("h3",{attrs:{id:"分页查询-from-size"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分页查询-from-size"}},[s._v("#")]),s._v(" 分页查询(from+size)")]),s._v(" "),a("p",[s._v("本质上就是from和size两个字段")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": { "match_all": {} },\n  "sort": [\n    { "account_number": "asc" }\n  ],\n  "from": 10,\n  "size": 10\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-4.png",alt:"img"}})]),s._v(" "),a("h3",{attrs:{id:"指定字段查询-match"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#指定字段查询-match"}},[s._v("#")]),s._v(" 指定字段查询：match")]),s._v(" "),a("p",[s._v("如果要在字段中搜索特定字词，可以使用"),a("code",[s._v("match")]),s._v("; 如下语句将查询address 字段中包含 mill 或者 lane的数据")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": { "match": { "address": "mill lane" } }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-5.png",alt:"img"}})]),s._v(" "),a("p",[s._v("（由于ES底层是按照分词索引的，所以上述查询结果是address 字段中包含 mill 或者 lane的数据）")]),s._v(" "),a("h3",{attrs:{id:"查询段落匹配-match-phrase"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询段落匹配-match-phrase"}},[s._v("#")]),s._v(" 查询段落匹配：match_phrase")]),s._v(" "),a("p",[s._v('如果我们希望查询的条件是 address字段中包含 "mill lane"，则可以使用'),a("code",[s._v("match_phrase")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": { "match_phrase": { "address": "mill lane" } }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-6.png",alt:"img"}})]),s._v(" "),a("h3",{attrs:{id:"多条件查询-bool"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多条件查询-bool"}},[s._v("#")]),s._v(" 多条件查询: bool")]),s._v(" "),a("p",[s._v("如果要构造更复杂的查询，可以使用"),a("code",[s._v("bool")]),s._v("查询来组合多个查询条件。")]),s._v(" "),a("p",[s._v("例如，以下请求在bank索引中搜索40岁客户的帐户，但不包括居住在爱达荷州（ID）的任何人")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        { "match": { "age": "40" } }\n      ],\n      "must_not": [\n        { "match": { "state": "ID" } }\n      ]\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-7.png",alt:"img"}})]),s._v(" "),a("p",[a("code",[s._v("must")]),s._v(", "),a("code",[s._v("should")]),s._v(", "),a("code",[s._v("must_not")]),s._v(" 和 "),a("code",[s._v("filter")]),s._v("\n都是"),a("code",[s._v("bool")]),s._v("查询的子句。那么"),a("code",[s._v("filter")]),s._v("和上述"),a("code",[s._v("query")]),s._v("子句有啥区别呢？")]),s._v(" "),a("h3",{attrs:{id:"查询条件-query-or-filter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询条件-query-or-filter"}},[s._v("#")]),s._v(" 查询条件：query or filter")]),s._v(" "),a("p",[s._v("先看下如下查询, 在"),a("code",[s._v("bool")]),s._v("查询的子句中同时具备query/must 和 filter")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        {\n          "match": {\n            "state": "ND"\n          }\n        }\n      ],\n      "filter": [\n        {\n          "term": {\n            "age": "40"\n          }\n        },\n        {\n          "range": {\n            "balance": {\n              "gte": 20000,\n              "lte": 30000\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-8.png",alt:"img"}})]),s._v(" "),a("p",[s._v("两者都可以写查询条件，而且语法也类似。区别在于，"),a("strong",[s._v("query 上下文的条件是用来给文档打分的，匹配越好 _score 越高；filter\n的条件只产生两种结果：符合与不符合，后者被过滤掉")]),s._v(" 。")]),s._v(" "),a("p",[s._v("所以，我们进一步看只包含filter的查询")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": {\n    "bool": {\n      "filter": [\n        {\n          "term": {\n            "age": "40"\n          }\n        },\n        {\n          "range": {\n            "balance": {\n              "gte": 20000,\n              "lte": 30000\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("结果，显然无_score")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-9.png",alt:"img"}})]),s._v(" "),a("h2",{attrs:{id:"聚合查询-aggregation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#聚合查询-aggregation"}},[s._v("#")]),s._v(" 聚合查询：Aggregation")]),s._v(" "),a("blockquote",[a("p",[s._v("我们知道SQL中有group by，在ES中它叫Aggregation，即聚合运算。")])]),s._v(" "),a("h3",{attrs:{id:"简单聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单聚合"}},[s._v("#")]),s._v(" 简单聚合")]),s._v(" "),a("p",[s._v("比如我们希望计算出account每个州的统计数量，\n使用"),a("code",[s._v("aggs")]),s._v("关键字对"),a("code",[s._v("state")]),s._v("字段聚合，被聚合的字段无需对分词统计，所以使用"),a("code",[s._v("state.keyword")]),s._v("对整个字段统计")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "size": 0,\n  "aggs": {\n    "group_by_state": {\n      "terms": {\n        "field": "state.keyword"\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-10.png",alt:"img"}})]),s._v(" "),a("p",[s._v("因为无需返回条件的具体数据, 所以设置size=0，返回hits为空。")]),s._v(" "),a("p",[a("code",[s._v("doc_count")]),s._v("表示bucket中每个州的数据条数。")]),s._v(" "),a("h3",{attrs:{id:"嵌套聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#嵌套聚合"}},[s._v("#")]),s._v(" 嵌套聚合")]),s._v(" "),a("p",[s._v("ES还可以处理个聚合条件的嵌套。")]),s._v(" "),a("p",[s._v("比如承接上个例子， 计算每个州的平均结余。涉及到的就是在对state分组的基础上，嵌套计算avg(balance):")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "size": 0,\n  "aggs": {\n    "group_by_state": {\n      "terms": {\n        "field": "state.keyword"\n      },\n      "aggs": {\n        "average_balance": {\n          "avg": {\n            "field": "balance"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-11.png",alt:"img"}})]),s._v(" "),a("h3",{attrs:{id:"对聚合结果排序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对聚合结果排序"}},[s._v("#")]),s._v(" 对聚合结果排序")]),s._v(" "),a("p",[s._v("可以通过在aggs中对嵌套聚合的结果进行排序")]),s._v(" "),a("p",[s._v("比如承接上个例子， 对嵌套计算出的avg(balance)，这里是average_balance，进行排序")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "size": 0,\n  "aggs": {\n    "group_by_state": {\n      "terms": {\n        "field": "state.keyword",\n        "order": {\n          "average_balance": "desc"\n        }\n      },\n      "aggs": {\n        "average_balance": {\n          "avg": {\n            "field": "balance"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/willpast/image/blog/ka_java/es-usage-12.png",alt:"img"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);