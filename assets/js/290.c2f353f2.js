(window.webpackJsonp=window.webpackJsonp||[]).push([[290],{622:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"elasticsearch-备份和迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch-备份和迁移"}},[s._v("#")]),s._v(" ElasticSearch - 备份和迁移")]),s._v(" "),a("h2",{attrs:{id:"方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方案"}},[s._v("#")]),s._v(" 方案")]),s._v(" "),a("h3",{attrs:{id:"离线方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#离线方案"}},[s._v("#")]),s._v(" 离线方案")]),s._v(" "),a("ul",[a("li",[s._v("Snapshot")]),s._v(" "),a("li",[s._v("Reindex")]),s._v(" "),a("li",[s._v("Logstash")]),s._v(" "),a("li",[s._v("ElasticSearch-dump")]),s._v(" "),a("li",[s._v("ElasticSearch-Exporter")])]),s._v(" "),a("h3",{attrs:{id:"增量备份方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#增量备份方案"}},[s._v("#")]),s._v(" 增量备份方案")]),s._v(" "),a("ul",[a("li",[s._v("logstash")])]),s._v(" "),a("h2",{attrs:{id:"使用快照进行备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用快照进行备份"}},[s._v("#")]),s._v(" 使用快照进行备份")]),s._v(" "),a("h3",{attrs:{id:"配置信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置信息"}},[s._v("#")]),s._v(" 配置信息")]),s._v(" "),a("p",[s._v("注册前要注意配置文件加上: elasticsearch.yml")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("path.repo: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/elasticsearch/backup"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"创建仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建仓库"}},[s._v("#")]),s._v(" 创建仓库")]),s._v(" "),a("blockquote",[a("p",[s._v("注册一个仓库，存放快照，记住，这里不是生成快照，只是注册一个仓库")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-XPUT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://10.11.60.5:9200/_snapshot/repo_backup_1'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n    "type": "fs",\n    "settings": {\n        "location": "/opt/elasticsearch/backup",\n        "max_snapshot_bytes_per_sec": "20mb",\n        "max_restore_bytes_per_sec": "20mb",\n        "compress": true\n    }\n}\'')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("查看仓库信息:")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-XGET")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://10.11.60.5:9200/_snapshot/repo_backup_1?pretty'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("返回内容")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@STOR-ES elasticsearch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -XGET 'http://10.11.60.5:9200/_snapshot/repo_backup_1?pretty'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"repo_backup_1"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fs"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"settings"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"location"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/elasticsearch/backup"')]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_restore_bytes_per_sec"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"20mb"')]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"compress"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_snapshot_bytes_per_sec"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"20mb"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h3",{attrs:{id:"创建快照"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建快照"}},[s._v("#")]),s._v(" 创建快照")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-XPUT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://10.11.60.5:9200/_snapshot/repo_backup_1/snapshot_1?wait_for_completion=true&pretty'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n    "indices": "bro-2019-09-14,bro-2019-09-15,wmi-2019-09-14,wmi-2019-09-15,syslog-2019-09-14,sylog-2019-09-15",\n    "rename_pattern": "bro_(.+)",\n    "rename_replacement": "dev_bro_$1",\n    "ignore_unavailable": true,\n    "include_global_state": true\n}\'')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("执行")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"snapshot"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"snapshot"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"snapshot_1"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2040399")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.4.3"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"indices"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bro-2019-09-14"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bro-2019-09-15"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wmi-2019-09-15"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"syslog-2019-09-14"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wmi-2019-09-14"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"state"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SUCCESS"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"start_time"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2019-09-18T05:58:08.860Z"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"start_time_in_millis"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1568786288860")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"end_time"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2019-09-18T06:02:18.037Z"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"end_time_in_millis"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1568786538037")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"duration_in_millis"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("249177")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failures"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shards"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(",\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"successful"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h3",{attrs:{id:"恢复数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#恢复数据"}},[s._v("#")]),s._v(" 恢复数据")]),s._v(" "),a("h2",{attrs:{id:"方案使用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方案使用场景"}},[s._v("#")]),s._v(" 方案使用场景")]),s._v(" "),a("h2",{attrs:{id:"迁移考虑的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#迁移考虑的问题"}},[s._v("#")]),s._v(" 迁移考虑的问题")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("版本问题，从低版本到高版本数据的迁移")])]),s._v(" "),a("li",[a("p",[s._v("多租户的适配问题")])])]),s._v(" "),a("blockquote",[a("p",[s._v("多个工厂的数据进入不同index, 原有的数据bro-2019-09-15的数据需要进入factorycode-bro-2019-09-15")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("多次或者分批迁移数据")])]),s._v(" "),a("li",[a("p",[s._v("数据在迁移时候富化")])]),s._v(" "),a("li",[a("p",[s._v("FieldMapping 和 数据信息 分离?")])])])])}),[],!1,null,null,null);a.default=e.exports}}]);